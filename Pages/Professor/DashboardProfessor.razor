@page "/professor/DashboardProfessor"
@namespace gestaopedagogica.Pages.Professor
@layout MainLayout
@using gestaopedagogica.Models
@using gestaopedagogica.Services
@using Microsoft.AspNetCore.Components.Authorization

@inject TrabalhoService TrabalhoService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<AuthorizeView Roles="Professor">
    <Authorized>
        <h3>Dashboard do Professor</h3>

        <div class="mb-3">
            <button class="btn btn-success" @onclick="CriarRoteiro">Criar Novo Roteiro</button>
        </div>

        <h5>Roteiros Criados</h5>
        @if (Lista.Count == 0)
        {
            <p><em>Nenhum roteiro criado.</em></p>
        }
        else
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Vertentes</th>
                        <th>Data de Criação</th>
                        <th>Status Envio</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Lista)
                    {
                        <tr>
                            <td>@item.Titulo</td>
                            <td>@string.Join(", ", item.Vertentes.Select(v => v.Tipo))</td>
                            <td>@item.DataCriacao.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@(string.IsNullOrEmpty(item.AlunoId) ? "Pendente" : "Enviado")</td>
                            <td>
                                <button class="btn btn-sm btn-primary"
                                        @onclick="() => AvaliarTrabalho(item)"
                                        disabled="@string.IsNullOrEmpty(item.AlunoId)">
                                    Avaliar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        @if (Selecionado != null)
        {
            <div class="card p-3 my-3">
                <h5>Avaliar Roteiro - @Selecionado.Titulo</h5>
                @foreach (var vert in Selecionado.Vertentes)
                {
                    <div class="mb-3">
                        <strong>@vert.Tipo</strong>
                        <p>@vert.ConteudoTexto</p>
                        <div class="mb-2">
                            <label>Nota:</label>
                            <input type="number" class="form-control" @bind="vert.Nota" min="0" max="10" step="0.1" />
                        </div>
                        <div class="mb-2">
                            <label>Feedback:</label>
                            <textarea class="form-control" @bind="vert.Feedback"></textarea>
                        </div>
                        <hr />
                    </div>
                }

                <button class="btn btn-success" @onclick="SalvarAvaliacao">Salvar Avaliação</button>
                <button class="btn btn-secondary ms-2" @onclick="CancelarAvaliacao">Cancelar</button>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-danger mt-5">
            <h4>Acesso Negado</h4>
            <p>Você não tem permissão para acessar o dashboard do professor.</p>
            <p>Por favor, <a href="/Identity/Account/Login">faça login novamente</a> com uma conta de professor.</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<TrabalhoViewModel> Lista { get; set; } = new();
    private TrabalhoViewModel? Selecionado { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var professorId = authState.User.FindFirst(c => c.Type == "sub")?.Value ?? "";

        var trabalhos = await TrabalhoService.GetTrabalhosDoProfessorAsync(professorId);

        Lista = trabalhos.Select(t => new TrabalhoViewModel
        {
            Id = t.Id,
            Titulo = t.Titulo,
            AlunoId = string.IsNullOrEmpty(t.AlunoId) ? null : t.AlunoId,
            DataCriacao = t.DataCriacao,
            Vertentes = t.TrabalhoVertentes.Select(v => new VertenteViewModel
            {
                Id = v.Id,
                Tipo = v.Tipo,
                ConteudoTexto = v.ConteudoTexto ?? "",
                Nota = v.Nota,
                Feedback = v.Feedback
            }).ToList()
        }).ToList();
    }

    private void CriarRoteiro() => Nav.NavigateTo("/professor/CriarRoteiro");

    private void AvaliarTrabalho(TrabalhoViewModel item) => Selecionado = item;

    private async Task SalvarAvaliacao()
    {
        if (Selecionado != null)
        {
            foreach (var vert in Selecionado.Vertentes)
            {
                var vertDb = await TrabalhoService.GetVertentePorIdAsync(vert.Id);
                if (vertDb != null)
                {
                    vertDb.Nota = vert.Nota ?? 0;
                    vertDb.Feedback = vert.Feedback ?? "";
                    vertDb.ConteudoTexto = vert.ConteudoTexto ?? "";
                    vertDb.Tipo = vert.Tipo ?? "";

                    await TrabalhoService.AtualizarVertenteAsync(vertDb);
                }
            }

            Selecionado = null;
            await OnInitializedAsync(); // Recarregar lista
        }
    }

    private void CancelarAvaliacao() => Selecionado = null;

    public class TrabalhoViewModel
    {
        public int Id { get; set; }
        public string Titulo { get; set; } = "";
        public string? AlunoId { get; set; }
        public DateTime DataCriacao { get; set; }
        public List<VertenteViewModel> Vertentes { get; set; } = new();
    }

    public class VertenteViewModel
    {
        public int Id { get; set; }
        public string Tipo { get; set; } = "";
        public string ConteudoTexto { get; set; } = "";
        public decimal? Nota { get; set; }
        public string? Feedback { get; set; }
    }
}
