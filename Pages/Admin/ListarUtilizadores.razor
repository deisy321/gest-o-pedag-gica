@page "/admin/ListarUtilizadores"
@namespace gestaopedagogica.Pages.Admin
@layout MainLayout
@using gestaopedagogica.Services
@inject UserService UserService
@inject NavigationManager Nav
@inject IJSRuntime JS

<AuthorizeView Roles="Administrador">
    <Authorized>
        <h3 class="mb-4">Gerir Utilizadores</h3>

        @if (ListaUsuarios == null)
        {
            <p><em>Carregando usuários...</em></p>
        }
        else if (!ListaUsuarios.Any())
        {
            <p><em>Nenhum usuário encontrado.</em></p>
        }
        else
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Função</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in ListaUsuarios)
                    {
                        <tr>
                            <td>@user.Nome</td>
                            <td>@user.Email</td>
                            <td>@user.Role</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" @onclick="() => EditarUsuario(user.Id)">Editar</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => ExcluirUsuario(user.Id)">Excluir</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <button class="btn btn-success mt-3" @onclick="CriarUsuario">Novo Usuário</button>
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-danger mt-5">
            <h4>Acesso Negado</h4>
            <p>Você não tem permissão para acessar esta página.</p>
            <p>Por favor, <a href="/login">faça login novamente</a> com uma conta de administrador.</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<UsuarioModel>? ListaUsuarios;

    protected override async Task OnInitializedAsync()
    {
        ListaUsuarios = await UserService.GetAllUsuariosAsync();
    }

    private void CriarUsuario()
    {
        Nav.NavigateTo("/admin/RegisterAdmin");
    }

    private void EditarUsuario(string userId)
    {
        Nav.NavigateTo($"/admin/EditarUsuario/{userId}");
    }

    private async Task ExcluirUsuario(string userId)
    {
        var confirmado = await JS.InvokeAsync<bool>("confirm", $"Tem certeza que deseja excluir este usuário?");
        if (confirmado)
        {
            await UserService.ExcluirUsuarioAsync(userId);
            ListaUsuarios = await UserService.GetAllUsuariosAsync(); // Recarrega lista após exclusão
        }
    }
}
