@page "/professor/DashboardProfessor"
@namespace gestaopedagogica.Pages.Professor
@layout MainLayout
@using gestaopedagogica.Models
@using gestaopedagogica.Services
@using Microsoft.AspNetCore.Components.Authorization

@inject TrabalhoService TrabalhoService
@inject AuthenticationStateProvider AuthStateProvider

<AuthorizeView Roles="Professor">
    <Authorized>
        <h3>Dashboard do Professor</h3>

        <!-- Módulos -->
        <div class="mb-4">
            <h5>Módulos que leciono</h5>
            @if (Modules?.Any() != true)
            {
                <p>Sem módulos atribuídos.</p>
            }
            else
            {
                <div class="list-group mb-3">
                    @foreach (var mod in Modules)
                    {
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@mod.Name</strong>
                                <div class="text-muted">Turmas: @string.Join(", ", mod.Classes)</div>
                            </div>
                            <div>
                                <a class="btn btn-sm btn-primary" href="/professor/AvaliarAlunos?moduleId=@mod.Id">Avaliar Alunos</a>
                                <a class="btn btn-sm btn-secondary ms-2" href="/professor/RelatoriosProfessor?moduleId=@mod.Id">Relatórios</a>
                                <a class="btn btn-sm btn-warning ms-2" href="/professor/TrabalhosRecebidos">Trabalhos Recebidos</a>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Trabalhos Recebidos -->
        <h5>Trabalhos Recebidos</h5>
        @if (Lista == null)
        {
            <p><em>Carregando trabalhos...</em></p>
        }
        else if (!Lista.Any())
        {
            <p><em>Nenhum trabalho encontrado.</em></p>
        }
        else
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Aluno</th>
                        <th>Título</th>
                        <th>Vertente</th>
                        <th>Data</th>
                        <th>Estado</th>
                        <th>Avaliar</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Lista)
                    {
                        <tr>
                            <td>@item.AlunoId</td>
                            <td>@item.Titulo</td>
                            <td>@item.Tipo</td>
                            <td>@item.DataEnvio.ToShortDateString()</td>
                            <td>@(item.Nota.HasValue ? "Avaliado" : "Pendente")</td>
                            <td>
                                <button class="btn btn-sm btn-primary" @onclick="() => AbrirAvaliar(item)">
                                    Avaliar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <!-- Avaliação inline -->
        @if (Selecionado != null)
        {
            <div class="card p-3 my-3">
                <h5>Avaliar @Selecionado.Tipo - @Selecionado.Titulo</h5>
                <p><strong>Aluno:</strong> @Selecionado.AlunoId</p>
                <p><strong>Conteúdo:</strong> @Selecionado.ConteudoTexto</p>

                <div class="mb-2">
                    <label>Nota:</label>
                    <input type="number" class="form-control" @bind="Selecionado.Nota" min="0" max="10" step="0.1" />
                </div>
                <div class="mb-2">
                    <label>Feedback:</label>
                    <textarea class="form-control" @bind="Selecionado.Feedback"></textarea>
                </div>

                <button class="btn btn-success" @onclick="SalvarAvaliacao">Salvar Avaliação</button>
                <button class="btn btn-secondary ms-2" @onclick="CancelarAvaliacao">Cancelar</button>
            </div>
        }

    </Authorized>
    <NotAuthorized>
        <div class="alert alert-danger mt-5">
            <h4>Acesso Negado</h4>
            <p>Você não tem permissão para acessar o dashboard do professor.</p>
            <p>Por favor, <a href="/Identity/Account/Login">faça login novamente</a> com uma conta de professor.</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<ModuleModel> Modules = new()
    {
        new ModuleModel{ Id=1, Name="Matemática", Classes=new List<string>{"Turma A","Turma B"} },
        new ModuleModel{ Id=2, Name="Física", Classes=new List<string>{"Turma C"} }
    };

    private List<VertenteViewModel>? Lista { get; set; }
    private VertenteViewModel? Selecionado { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var professorId = user.FindFirst(c => c.Type == "sub")?.Value ?? "";

        var trabalhos = await TrabalhoService.GetTrabalhosDoProfessorAsync(professorId);

        // Lista de vertentes com dados do trabalho
        Lista = trabalhos
            .SelectMany(t => t.TrabalhoVertentes, (t, v) => new VertenteViewModel
            {
                Vertente = v,
                Id = v.Id,
                TrabalhoId = t.Id,
                AlunoId = t.AlunoId,
                Titulo = t.Titulo,
                Tipo = v.Tipo,
                DataEnvio = v.DataEnvio,
                Nota = v.Nota, // 👈 decimal? diretamente
                Feedback = v.Feedback,
                ConteudoTexto = v.ConteudoTexto
            })
            .ToList();
    }

    private void AbrirAvaliar(VertenteViewModel item)
    {
        Selecionado = item;
    }

    private async Task SalvarAvaliacao()
    {
        if (Selecionado != null)
        {
            await TrabalhoService.AtualizarVertenteAsync(Selecionado.Vertente);
            Selecionado = null;
            await OnInitializedAsync();
        }
    }

    private void CancelarAvaliacao()
    {
        Selecionado = null;
    }

    public class ModuleModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public List<string> Classes { get; set; } = new();
    }

    public class VertenteViewModel
    {
        public int Id { get; set; }
        public int TrabalhoId { get; set; }
        public string AlunoId { get; set; } = "";
        public string Titulo { get; set; } = "";
        public string Tipo { get; set; } = "";
        public DateTime DataEnvio { get; set; }
        public decimal? Nota { get; set; } 
        public string? Feedback { get; set; }
        public string ConteudoTexto { get; set; } = "";
        public TrabalhoVertente Vertente { get; set; } = new TrabalhoVertente();
    }
}
