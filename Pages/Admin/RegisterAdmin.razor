@page "/admin/RegisterAdmin"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using gestaopedagogica.Data
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@attribute [Authorize(Roles = "Administrador")]
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Navigation
@inject ILogger<RegisterAdmin> Logger
@namespace gestaopedagogica.Pages.Admin
@layout MainLayout

<AuthorizeView Roles="Administrador">
    <Authorized Context="authContext">
        <div class="container mt-4">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="card shadow-lg">
                        <div class="card-body">
                            <h2 class="text-center mb-2">Gestão Pedagógica</h2>
                            <p class="text-center text-muted mb-4">Registar Novo Utilizador</p>

                            @if (!string.IsNullOrEmpty(ErrorMessage))
                            {
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <strong>Erro:</strong> @ErrorMessage
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            }

                            @if (ShowSuccessMessage)
                            {
                                <div class="alert alert-success alert-dismissible fade show" role="alert">
                                    <strong>Sucesso:</strong> Utilizador registado com sucesso!
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            }

                            <EditForm EditContext="new EditContext(Input)" OnValidSubmit="HandleRegisterAsync">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="text-danger" />

                                <div class="mb-3">
                                    <label for="email" class="form-label">Email do Utilizador <span class="text-danger">*</span></label>
                                    <InputText id="email" @bind-Value="Input.Email" class="form-control form-control-lg" placeholder="usuario@exemplo.com" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Tipo de Utilizador <span class="text-danger">*</span></label>
                                    <InputRadioGroup @bind-Value="SelectedRole">
                                        @foreach (var role in UserRoles.AllRoles)
                                        {
                                            <div class="form-check">
                                                <InputRadio Value="@role.Key" class="form-check-input" id="@role.Key" />
                                                <label class="form-check-label" for="@role.Key">
                                                    <span class="role-badge @role.Value.CssClass">@role.Value.DisplayName</span>
                                                </label>
                                            </div>
                                        }
                                    </InputRadioGroup>
                                </div>

                                <div class="mb-3">
                                    <label for="password" class="form-label">Senha <span class="text-danger">*</span></label>
                                    <InputText id="password" type="password" @bind-Value="Input.Password" class="form-control form-control-lg" placeholder="Mínimo 6 caracteres" />
                                </div>

                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">Confirmar Senha <span class="text-danger">*</span></label>
                                    <InputText id="confirmPassword" type="password" @bind-Value="Input.ConfirmPassword" class="form-control form-control-lg" placeholder="Confirme a senha" />
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg w-100 mb-3" disabled="@IsSubmitting">
                                    @(IsSubmitting ? "A processar..." : "Registar Utilizador")
                                </button>
                            </EditForm>

                            <hr />

                            <div class="text-center">
                                <p class="mb-2">Voltar para:</p>
                                <a href="/admin/DashboardAdmin" class="btn btn-outline-primary w-100">Dashboard Admin</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .role-badge {
                display: inline-block;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 12px;
                font-weight: bold;
                margin: 5px 5px 5px 0;
            }

            .role-admin {
                background-color: #dc3545;
                color: white;
            }

            .role-professor {
                background-color: #007bff;
                color: white;
            }

            .role-aluno {
                background-color: #28a745;
                color: white;
            }
        </style>
    </Authorized>

    <NotAuthorized>
        <div class="alert alert-danger mt-5">
            <h4>Acesso Negado</h4>
            <p>Você não tem permissão para registar utilizadores.</p>
            <p>Por favor, <a href="/login">faça login novamente</a> com uma conta de administrador.</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private RegisterAdminInputModel Input { get; set; } = new();
    private string SelectedRole { get; set; } = "Aluno";
    private string ErrorMessage { get; set; } = string.Empty;
    private bool ShowSuccessMessage { get; set; } = false;
    private bool IsSubmitting { get; set; } = false;

    public static class UserRoles
    {
        public record RoleInfo(string DisplayName, string CssClass);

        public static readonly Dictionary<string, RoleInfo> AllRoles = new()
        {
            { "Aluno", new RoleInfo("Aluno", "role-aluno") },
            { "Professor", new RoleInfo("Professor", "role-professor") },
            { "Administrador", new RoleInfo("Administrador", "role-admin") }
        };
    }

    private async Task HandleRegisterAsync()
    {
        IsSubmitting = true;
        ErrorMessage = string.Empty;
        ShowSuccessMessage = false;

        if (string.IsNullOrWhiteSpace(Input.Email))
        {
            ErrorMessage = "Email é obrigatório.";
            IsSubmitting = false;
            return;
        }

        if (!UserRoles.AllRoles.ContainsKey(SelectedRole))
        {
            ErrorMessage = "Tipo de utilizador inválido.";
            IsSubmitting = false;
            return;
        }

        if (Input.Password != Input.ConfirmPassword)
        {
            ErrorMessage = "As senhas não correspondem.";
            IsSubmitting = false;
            return;
        }

        if (Input.Password.Length < 6)
        {
            ErrorMessage = "A senha deve ter pelo menos 6 caracteres.";
            IsSubmitting = false;
            return;
        }

        var existingUser = await UserManager.FindByEmailAsync(Input.Email);
        if (existingUser != null)
        {
            ErrorMessage = "Este email já está registado no sistema.";
            IsSubmitting = false;
            return;
        }

        var user = new ApplicationUser { UserName = Input.Email, Email = Input.Email, EmailConfirmed = true };
        var result = await UserManager.CreateAsync(user, Input.Password);

        if (result.Succeeded)
        {
            await UserManager.AddToRoleAsync(user, SelectedRole);
            ShowSuccessMessage = true;
            Input = new RegisterAdminInputModel();
            SelectedRole = "Aluno";

            await Task.Delay(2000);
            Navigation.NavigateTo("/admin/DashboardAdmin", true);
        }
        else
        {
            ErrorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
        }

        IsSubmitting = false;
    }

    public class RegisterAdminInputModel
    {
        [Required(ErrorMessage = "O email é obrigatório")]
        [EmailAddress(ErrorMessage = "Email inválido")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "A senha é obrigatória")]
        [StringLength(100, MinimumLength = 6, ErrorMessage = "A senha deve ter pelo menos 6 caracteres.")]
        public string Password { get; set; } = string.Empty;

        [DataType(DataType.Password)]
        [Compare(nameof(Password), ErrorMessage = "A senha e a confirmação não correspondem.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
