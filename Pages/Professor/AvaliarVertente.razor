@page "/professor/AvaliarVertente/{TrabalhoId:int}/{TipoVertente}"
@using gestaopedagogica.Data
@using gestaopedagogica.Models
@inject ApplicationDbContext _context
@inject NavigationManager Nav

<h3>Avaliar Vertente</h3>

@if (Vertente == null)
{
    <p>Carregando...</p>
}
else
{
    <div class="card p-4">

        <p><strong>Tipo:</strong> @Vertente.Tipo</p>

        @* Se houver ficheiro guardado no banco, mostra link para download *@
        @if (Vertente.FicheiroBytes != null)
        {
            <p>
                <a href="/ficheiro/vertente/@Vertente.Id" target="_blank">
                    Baixar ficheiro enviado
                </a>
            </p>
        }

        @if (!string.IsNullOrEmpty(Vertente.ConteudoTexto))
        {
            <p><strong>Texto enviado:</strong></p>
            <p>@Vertente.ConteudoTexto</p>
        }

        <div class="mt-3">
            <label>Nota</label>
            <input type="number" class="form-control" style="width:120px" @bind="Vertente.Nota" min="0" max="20" />
        </div>

        <div class="mt-3">
            <label>Feedback</label>
            <textarea class="form-control" @bind="Vertente.Feedback"></textarea>
        </div>

        <button class="btn btn-success mt-3" @onclick="Salvar">Salvar</button>

    </div>
}

@code {
    [Parameter] public int TrabalhoId { get; set; }
    [Parameter] public string TipoVertente { get; set; } = "";

    private TrabalhoVertente? Vertente { get; set; }

    protected override void OnInitialized()
    {
        // Busca a vertente pelo trabalho e tipo
        Vertente = _context.TrabalhoVertentes
                    .FirstOrDefault(v => v.TrabalhoId == TrabalhoId && v.Tipo == TipoVertente);

        if (Vertente == null)
        {
            Console.WriteLine($"⚠️ Vertente não encontrada: TrabalhoId={TrabalhoId}, Tipo={TipoVertente}");
        }
    }

    private async Task Salvar()
    {
        if (Vertente != null)
        {
            _context.TrabalhoVertentes.Update(Vertente);
            await _context.SaveChangesAsync();

            // Redireciona de volta ao dashboard do professor
            Nav.NavigateTo("/professor/TrabalhosRecebidos");
        }
    }
}
