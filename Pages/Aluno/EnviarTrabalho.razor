@page "/aluno/EnviarTrabalho/{id:int}"
@namespace gestaopedagogica.Pages.Aluno
@layout MainLayout
@using gestaopedagogica.Models
@using gestaopedagogica.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject TrabalhoService TrabalhoService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<h3>Enviar Trabalho</h3>

@if (!string.IsNullOrEmpty(StatusMessage))
{
    <div class="alert alert-info">@StatusMessage</div>
}

<div class="card p-4">
    <div class="mb-3">
        <label>Título do Trabalho</label>
        <input class="form-control" @bind="Titulo" disabled />
    </div>

    <hr />

    @foreach (var vertente in Vertentes)
    {
        <h5>@vertente.Tipo</h5>

        @if (!string.IsNullOrEmpty(vertente.FicheiroPath))
        {
            <p>Arquivo atual: <a href="@vertente.FicheiroPath" target="_blank">@vertente.FicheiroPath</a></p>
        }

        <InputFile OnChange="e => OnFileSelected(e, vertente)" />
        <textarea class="form-control mt-2" placeholder="Ou escreva aqui..." @bind="vertente.ConteudoTexto"></textarea>
        <hr />
    }

    <button class="btn btn-success mt-4" @onclick="Enviar" disabled="@IsSending">
        @(IsSending ? "Enviando..." : "Enviar Trabalho")
    </button>
</div>

@code {
    [Parameter] public int id { get; set; } // ID do trabalho criado pelo professor
    private string Titulo { get; set; } = "";
    private string StatusMessage { get; set; } = "";
    private bool IsSending = false;

    private List<VertenteEditModel> Vertentes { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Carregar trabalho criado pelo professor
        var trabalho = await TrabalhoService.GetTrabalhoPorIdAsync(id);
        if (trabalho == null)
        {
            StatusMessage = "❌ Trabalho não encontrado!";
            return;
        }

        Titulo = trabalho.Titulo;

        // Carregar vertentes
        var vertentesDb = await TrabalhoService.GetVertentesDoTrabalhoAsync(trabalho.Id);
        Vertentes = vertentesDb.Select(v => new VertenteEditModel
        {
            Id = v.Id,
            Tipo = v.Tipo,
            ConteudoTexto = v.ConteudoTexto ?? "",
            FicheiroPath = v.FicheiroPath
        }).ToList();
    }

    private void OnFileSelected(InputFileChangeEventArgs e, VertenteEditModel vertente)
    {
        vertente.File = e.File;
    }

    private async Task Enviar()
    {
        IsSending = true;
        StatusMessage = "";
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var alunoId = user.FindFirst(c => c.Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value;

            if (string.IsNullOrEmpty(alunoId))
            {
                StatusMessage = "❌ Erro: aluno não encontrado.";
                return;
            }

            var trabalho = await TrabalhoService.GetTrabalhoPorIdAsync(id);
            if (trabalho == null)
            {
                StatusMessage = "❌ Trabalho não encontrado.";
                return;
            }

            // Preencher dados de envio
            trabalho.AlunoId = alunoId;
            trabalho.DataEnvio = DateTime.Now;
            await TrabalhoService.AtualizarTrabalhoAsync(trabalho);

            foreach (var vert in Vertentes)
            {
                await SalvarVertente(trabalho.Id, vert);
            }

            StatusMessage = "✅ Trabalho enviado com sucesso!";
            Nav.NavigateTo("/aluno/DashboardAluno");
        }
        catch (Exception ex)
        {
            StatusMessage = "❌ Erro ao enviar: " + ex.Message + " | " + ex.InnerException?.Message;
        }
        finally
        {
            IsSending = false;
        }
    }

    private async Task SalvarVertente(int trabalhoId, VertenteEditModel vert)
    {
        string? path = null;

        if (vert.File != null)
        {
            var folder = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads");
            Directory.CreateDirectory(folder);
            var fileName = $"{Guid.NewGuid()}_{vert.File.Name}";
            var filePath = Path.Combine(folder, fileName);

            using var stream = File.Create(filePath);
            await vert.File.OpenReadStream(10485760).CopyToAsync(stream); // 10MB limite
            path = "/uploads/" + fileName;
        }

        var vertenteDb = await TrabalhoService.GetVertentePorIdAsync(vert.Id);
        if (vertenteDb != null)
        {
            vertenteDb.ConteudoTexto = vert.ConteudoTexto ?? "";
            if (path != null) vertenteDb.FicheiroPath = path;
            await TrabalhoService.AtualizarVertenteAsync(vertenteDb);
        }
    }

    public class VertenteEditModel
    {
        public int Id { get; set; }
        public string Tipo { get; set; } = "";
        public string ConteudoTexto { get; set; } = "";
        public string FicheiroPath { get; set; } = "";
        public IBrowserFile? File { get; set; }
    }
}
