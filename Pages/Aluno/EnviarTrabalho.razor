@page "/aluno/EnviarTrabalho"
@namespace gestaopedagogica.Pages.Aluno
@layout MainLayout
@using gestaopedagogica.Models
@using gestaopedagogica.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject TrabalhoService TrabalhoService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<h3>@(IsEdit ? "Editar Trabalho" : "Enviar Trabalho")</h3>

<div class="card p-4">
    <div class="mb-3">
        <label>Título do Trabalho</label>
        <input class="form-control" @bind="Titulo" />
    </div>

    <hr />

    @foreach (var vertente in Vertentes)
    {
        <h5>@vertente.Tipo</h5>

        @if (!string.IsNullOrEmpty(vertente.FicheiroPath))
        {
            <p>Arquivo atual: <a href="@vertente.FicheiroPath" target="_blank">@vertente.FicheiroPath</a></p>
        }

        <InputFile OnChange="e => OnFileSelected(e, vertente)" />
        <textarea class="form-control mt-2" placeholder="Ou escreva aqui..." @bind="vertente.ConteudoTexto"></textarea>
        <hr />
    }

    <button class="btn btn-success mt-4" @onclick="Enviar">@ButtonText</button>
</div>

@code {
    [Parameter] public int? id { get; set; }
    private bool IsEdit => id.HasValue;
    private string ButtonText => IsEdit ? "Atualizar Trabalho" : "Enviar Trabalho";

    private string Titulo { get; set; } = "";

    private List<VertenteEditModel> Vertentes { get; set; } = new List<VertenteEditModel>
    {
        new VertenteEditModel { Tipo = "Competencia" },
        new VertenteEditModel { Tipo = "Aptidao" },
        new VertenteEditModel { Tipo = "Conhecimento" }
    };

    protected override async Task OnInitializedAsync()
    {
        if (!IsEdit) return;

        var trabalho = await TrabalhoService.GetTrabalhoPorIdAsync(id!.Value);
        if (trabalho != null)
        {
            Titulo = trabalho.Titulo;

            var vertentesDb = await TrabalhoService.GetVertentesDoTrabalhoAsync(trabalho.Id);

            foreach (var vert in Vertentes)
            {
                var dbVert = vertentesDb.FirstOrDefault(v => v.Tipo == vert.Tipo);
                if (dbVert != null)
                {
                    vert.ConteudoTexto = dbVert.ConteudoTexto ?? "";
                    vert.FicheiroPath = dbVert.FicheiroPath ?? "";
                    vert.Id = dbVert.Id;
                }
            }
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e, VertenteEditModel vertente)
    {
        vertente.File = e.File;
    }

    private async Task Enviar()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var alunoId = user.FindFirst(c => c.Type == "sub")?.Value;

        if (string.IsNullOrEmpty(alunoId))
        {
            // caso não encontre o aluno
            return;
        }

        Trabalho trabalho;
        if (IsEdit)
        {
            trabalho = await TrabalhoService.GetTrabalhoPorIdAsync(id!.Value) ?? new Trabalho();
            trabalho.Titulo = Titulo;
            trabalho.DataEnvio = DateTime.Now;
        }
        else
        {
            trabalho = new Trabalho
            {
                AlunoId = alunoId,
                ProfessorId = "prof1", // pegar professor correto futuramente
                Titulo = Titulo,
                DataEnvio = DateTime.Now
            };
            await TrabalhoService.AddTrabalhoAsync(trabalho);
        }

        foreach (var vert in Vertentes)
        {
            await SalvarVertente(trabalho.Id, vert);
        }

        Nav.NavigateTo("/aluno/DashboardAluno");
    }

    private async Task SalvarVertente(int trabalhoId, VertenteEditModel vert)
    {
        string? path = null;

        if (vert.File != null)
        {
            var folder = Path.Combine("wwwroot", "uploads");
            Directory.CreateDirectory(folder);
            var fileName = $"{Guid.NewGuid()}_{vert.File.Name}";
            var filePath = Path.Combine(folder, fileName);
            using var stream = File.Create(filePath);
            await vert.File.OpenReadStream().CopyToAsync(stream);
            path = "/uploads/" + fileName;
        }

        var vertentesDb = await TrabalhoService.GetVertentesDoTrabalhoAsync(trabalhoId);
        var vertenteDb = vertentesDb.FirstOrDefault(v => v.Tipo == vert.Tipo);

        if (vertenteDb != null)
        {
            vertenteDb.ConteudoTexto = vert.ConteudoTexto ?? "";
            if (path != null) vertenteDb.FicheiroPath = path;
            await TrabalhoService.AtualizarVertenteAsync(vertenteDb);
        }
        else
        {
            vertenteDb = new TrabalhoVertente
            {
                TrabalhoId = trabalhoId,
                Tipo = vert.Tipo,
                ConteudoTexto = vert.ConteudoTexto ?? "",
                FicheiroPath = path ?? ""
            };
            await TrabalhoService.AddVertenteAsync(vertenteDb);
        }
    }

    public class VertenteEditModel
    {
        public int Id { get; set; }
        public string Tipo { get; set; } = "";
        public string ConteudoTexto { get; set; } = "";
        public string FicheiroPath { get; set; } = "";
        public IBrowserFile? File { get; set; }
    }
}
