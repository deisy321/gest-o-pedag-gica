@page "/professor/TrabalhosRecebidos"
@layout MainLayout
@using gestaopedagogica.Models
@using gestaopedagogica.Services
@using Microsoft.AspNetCore.Components.Authorization

@inject TrabalhoService TrabalhoService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<h3>Trabalhos Enviados</h3>

@if (Lista == null || !Lista.Any())
{
    <p><em>Nenhum trabalho encontrado.</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Aluno</th>
                <th>Título</th>
                <th>Vertente</th>
                <th>Data</th>
                <th>Estado</th>
                <th>Avaliar</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Lista)
            {
                <tr>
                    <td>@item.AlunoId</td>
                    <td>@item.Titulo</td>
                    <td>@item.Tipo</td>
                    <td>@(item.DataEnvio?.ToShortDateString() ?? "-")</td>
                    <td>@(item.Nota == null ? "Pendente" : "Avaliado")</td>
                    <td>
                        <button class="btn btn-sm btn-primary"
                                @onclick="() => AbrirAvaliar(item.Id)">
                            Avaliar
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (Selecionado != null)
{
    <div class="card p-3 my-3">
        <h5>Avaliar @Selecionado.Tipo - @Selecionado.Titulo</h5>

        <div class="mb-2">
            <label>Nota</label>
            <input class="form-control" type="number" step="0.01"
                   @bind="Selecionado.Nota" />
        </div>

        <div class="mb-2">
            <label>Feedback</label>
            <textarea class="form-control"
                      @bind="Selecionado.Feedback"></textarea>
        </div>

        <button class="btn btn-success" @onclick="SalvarAvaliacao">Salvar</button>
        <button class="btn btn-secondary ms-2" @onclick="CancelarAvaliacao">Cancelar</button>
    </div>
}

@code {
    // ViewModel com DataEnvio nullable
    class VertenteViewModel
    {
        public int Id { get; set; }
        public int TrabalhoId { get; set; }
        public string Titulo { get; set; } = "";
        public string AlunoId { get; set; } = "";
        public string Tipo { get; set; } = "";
        public DateTime? DataEnvio { get; set; }  // <- nullable
        public decimal? Nota { get; set; }
        public string Feedback { get; set; } = "";
        public string ConteudoTexto { get; set; } = "";
    }

    List<VertenteViewModel> Lista = new();
    VertenteViewModel? Selecionado;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var professorId = authState.User.FindFirst("sub")?.Value ?? "";

        var trabalhos = await TrabalhoService.GetTrabalhosDoProfessorAsync(professorId);

        Lista = trabalhos
            .SelectMany(t => t.TrabalhoVertentes.Select(v => new VertenteViewModel
            {
                Id = v.Id,
                TrabalhoId = t.Id,
                Titulo = t.Titulo,
                AlunoId = t.AlunoId,
                Tipo = v.Tipo,
                DataEnvio = v.DataEnvio,   // Nullable agora
                Nota = v.Nota,
                Feedback = v.Feedback,
                ConteudoTexto = v.ConteudoTexto
            }))
            .ToList();
    }

    void AbrirAvaliar(int id) =>
        Selecionado = Lista.FirstOrDefault(v => v.Id == id);

    async Task SalvarAvaliacao()
    {
        if (Selecionado == null) return;

        var vertente = await TrabalhoService.GetVertentePorIdAsync(Selecionado.Id);
        if (vertente != null)
        {
            vertente.Nota = Selecionado.Nota;
            vertente.Feedback = Selecionado.Feedback;
            await TrabalhoService.AtualizarVertenteAsync(vertente);
        }

        Selecionado = null;
        await OnInitializedAsync(); // Recarrega a lista
    }

    void CancelarAvaliacao() => Selecionado = null;
}
