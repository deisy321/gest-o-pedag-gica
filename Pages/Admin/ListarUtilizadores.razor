@page "/admin/ListarUtilizadores"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using gestaopedagogica.Data
@attribute [Authorize(Roles = "Administrador")]
@namespace gestaopedagogica.Pages.Admin
@layout MainLayout
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager

<h3>Gerir Utilizadores</h3>

<div class="row mb-3">
  <div class="col-md-12">
        <a href="/admin/DashboardAdmin" class="btn btn-outline-secondary">?? Voltar ao Dashboard</a>
        <a href="/admin/RegisterAdmin" class="btn btn-success">? Registar Novo Utilizador</a>
    </div>
</div>

@if (utilizadores == null)
{
  <div class="alert alert-info">A carregar utilizadores...</div>
}
else if (utilizadores.Count == 0)
{
    <div class="alert alert-warning">Nenhum utilizador encontrado no sistema.</div>
}
else
{
    <div class="card">
  <div class="card-body">
   <h5 class="card-title">Total de Utilizadores: @utilizadores.Count</h5>
 
       <div class="table-responsive">
   <table class="table table-striped table-hover">
      <thead class="table-dark">
     <tr>
    <th>Email</th>
          <th>Username</th>
     <th>Tipo de Utilizador</th>
<th>Email Confirmado</th>
       <th>Data de Registo</th>
         <th>Ações</th>
</tr>
</thead>
   <tbody>
     @foreach (var user in utilizadores)
      {
       <tr>
       <td>@user.Email</td>
     <td>@user.UserName</td>
        <td>
  @{
           var roles = rolesDoUtilizador.ContainsKey(user.Id) ? rolesDoUtilizador[user.Id] : new List<string>();
       var roleName = roles.FirstOrDefault() ?? "Sem role";
  }
    <span class="badge @GetRoleBadgeClass(roleName)">
       @GetRoleEmoji(roleName) @roleName
        </span>
          </td>
   <td>
  @if (user.EmailConfirmed)
    {
      <span class="badge bg-success">? Confirmado</span>
 }
      else
    {
            <span class="badge bg-warning">? Pendente</span>
   }
    </td>
               <td>@user.Id.Substring(0, 8)...</td>
        <td>
     <button class="btn btn-sm btn-info" @onclick="() => VerDetalhes(user)">Detalhes</button>
       @if (user.UserName != "admin@local")
{
    <button class="btn btn-sm btn-danger" @onclick="() => Deletar(user)">Deletar</button>
        }
  </td>
     </tr>
    }
       </tbody>
 </table>
    </div>
        </div>
</div>
}

@code {
    private List<ApplicationUser> utilizadores;
    private Dictionary<string, List<string>> rolesDoUtilizador = new();

    protected override async Task OnInitializedAsync()
    {
        await CarregarUtilizadores();
  }

 private async Task CarregarUtilizadores()
    {
   utilizadores = UserManager.Users.ToList();
   rolesDoUtilizador.Clear();

        foreach (var user in utilizadores)
     {
         var roles = await UserManager.GetRolesAsync(user);
        rolesDoUtilizador[user.Id] = roles.ToList();
        }
    }

  private void VerDetalhes(ApplicationUser user)
    {
        var roles = rolesDoUtilizador.ContainsKey(user.Id) ? string.Join(", ", rolesDoUtilizador[user.Id]) : "Sem role";
        System.Diagnostics.Debug.WriteLine($"Utilizador: {user.Email} - Roles: {roles}");
  }

  private async Task Deletar(ApplicationUser user)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Tem certeza que quer deletar {user.Email}?"))
     {
    await UserManager.DeleteAsync(user);
            await CarregarUtilizadores();
 StateHasChanged();
        }
    }

private string GetRoleBadgeClass(string role)
    {
        return role switch
        {
       "Administrador" => "bg-danger",
"Professor" => "bg-primary",
    "Aluno" => "bg-success",
        _ => "bg-secondary"
        };
    }

    private string GetRoleEmoji(string role)
    {
        return role switch
        {
    "Administrador" => "??",
     "Professor" => "?????",
    "Aluno" => "?????",
 _ => "?"
        };
    }

 [Inject]
    private IJSRuntime JSRuntime { get; set; }
}
